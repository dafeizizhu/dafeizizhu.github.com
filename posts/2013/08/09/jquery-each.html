<!DOCTYPE html>
<html>

  <head>
    <title>jQuery源码解析之jQuery.each</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <link rel="stylesheet" href="/common/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="/css/blog.css">
  </head>

  <body>
    <div class="blog-masthead">
      <div class="container">
        <nav class="blog-nav"><a href="/" class="blog-nav-item active">主页</a><a href="/posts" class="blog-nav-item">文章</a><a href="/tags" class="blog-nav-item">标签</a><a href="/projects" class="blog-nav-item">项目</a><a href="/about" class="blog-nav-item">关于</a></nav>
      </div>
    </div>
    <div class="container">
      <div class="blog-header">
        <h1 class="blog-title">小麦的二三事</h1>
        <p class="lead blog-description">他大舅他二舅，都是他舅</p>
      </div>
      <div class="col-sm-8 blog-main">
        <div class="row">
          <div class="blog-post">
            <h2 class="blog-post-title">jQuery源码解析之jQuery.each</h2>
            <p class="blog-post-meta">写于2013年08月09日 关于<a href="/tags/JavaScript">JavaScript</a>,<a href="/tags/jQuery">jQuery</a></p>
            <p>昨天讨论了<code>for...in</code>的用法，今天来看一个可能我们日常使用频率更高另外一个遍历的方法：<code>jQuery.each</code>。先来看看jQuery对<code>each</code>的描述：</p>
            <blockquote>
              <p>A generic iterator function, which can be used to seamlessly iterate over both objects and arrays. Arrays and array-like objects with a length property (such as a function&#39;s arguments object) are iterated by numeric index, from 0 to
                length-1. Other objects are iterated via their named properties.</p>
            </blockquote>
            <p>从描述中可以看出来，<code>jQuery.each</code>即可以遍历数组（包括<code>arguments</code>对象），也可以遍历一个对象上的属性。该方法接受两个参数：</p>
            <ol>
              <li><code>collection</code>，需要遍历的数组或者对象。</li>
              <li><code>callback</code>，遍历时的回调函数，该函数接受两个参数，一个是这次遍历的下标（数组）或者键值（对象），另一个是这次遍历的迭代子的值。</li>
            </ol>
            <p>执行这个方法返回的是被遍历的对象，便于写出链式写法的代码。</p>
            <p>在每次遍历的回调中，我们可以通过<code>return false</code>来实现<code>for</code>循环中的<code>break</code>功能，通过返回非<code>false</code>的值来实现<code>continue</code>的功能。如以下代码：</p> <pre><code>$.each([1, 2, 3, 4], function(i, v) {
  if (v === 1) {
    return true;
  }
  if (v === 3) {
    return false;
  }
  console.log(v);
});
</code></pre>
            <p>执行结果<a href="http://jsfiddle.net/HWh6Y/show">参考这里</a>。</p>
            <p>再来看看最新的jQuery的<code>each</code>的源码。</p> <pre><code>// args is for internal usage only
each: function( obj, callback, args ) {
</code></pre>
            <p>首先可以看到原来<code>each</code>是接受三个参数的，第三个参数只能内部使用。首先使用<code>isArraylike</code>来判断<code>obj</code>是否一个类似数组的东西（如有<code>length</code>属性，并可以通过下标访问等）。如果是，则用普通的<code>for</code>循环来遍历这个数组；如果不是，则使用<code>for...in</code>来遍历这个对象。这里分享一个小插曲，在<code>isArraylike</code>函数里面有这么一句代码：</p>
            <pre><code>return type === &quot;array&quot; || type !== &quot;function&quot; &amp;&amp;
    ( length === 0 ||
    typeof length === &quot;number&quot; &amp;&amp; length &gt; 0 &amp;&amp; ( length - 1 ) in obj );
</code></pre>
            <p>最后那个<code>(length - 1) in obj</code>是什么意思呢，为啥这样可以说明这个<code>obj</code>是一个类似数组的东西？原来<code>[1, 2]</code>的内部结构可以这么表述：</p> <pre><code>{&quot;0&quot;: 1, &quot;1&quot;: 2}
</code></pre>
            <p>所以<code>length - 1</code>这个键在类似数组的对象中是存在的，而其他对象如果键值没有显式声明成<code>1</code>的话是不会符合这个规则的。所以这个也被用作是判断一个对象是否是一个类数组的条件之一。使用这个条件可以弥补只判断<code>length</code>属性是否是数字的不足。</p>
            <p>当提供了第三个<code>args</code>参数时，在调用回调的时候会使用<code>apply</code>把<code>args</code>当作参数传到回调中，否则会使用<code>call</code>把下标或者键值、对应的值当作参数传到回调之中，后者也是我们日常使用的场景。回调函数执行的上下文<code>this</code>都是当前遍历的值，也就是日常使用场景中的第二个参数。</p>
            <p>如果回调返回了<code>false</code>则停止遍历。要注意，如果要使用<code>break</code>的功能，一定要<code>return false</code>，不能返回强制转换后是<code>false</code>的值，例如<code>0</code>或者空字符串等等。因为这里使用的是<code>===</code>来判断：</p> <pre><code>value = callback.call( obj[ i ], i, obj[ i ] );
if ( value === false ) {
  break;
}
</code></pre>
            <p>遍历对象的时候是使用了普通的<code>for...in</code>循环，并没有像昨天讨论的加上<code>hasOwnProperty</code>的保护，所以使用<code>jQuery.each</code>会遍历所有能被遍历的属性，包括原型链上的属性哦。</p>
            <p>最后就是一些小细节了，例如无论是下标或者键值都用同一个变量<code>i</code>作为迭代计数、<code>for</code>循环中连迭代计数的初始化<code>i = 0</code>都省略了等。前者可以减少局部变量的数目，后者可以使代码压缩后体积更小（虽然效果有限……）。</p>
            <nav class="pager">
              <li><a href="/posts/2013/08/08/javascript-iteract-an-object.html" title="在JavaScript中遍历一个对象的所有属性">上一篇</a></li>
              <li><a href="/posts/2013/08/10/javascript-oo-gotchas.html" title="Secrets of the JavaScript Ninja 读书笔记之 面向对象陷阱">下一篇</a></li>
            </nav>
          </div>
        </div>
      </div>
      <div class="col-sm-3 col-sm-offset-1 blog-sidebar">
        <div class="sidebar-module">
          <h4>文章</h4>
          <ol class="list-unstyled">
            <li><a href="/posts/2014/02">2014年02月</a></li>
            <li><a href="/posts/2014/01">2014年01月</a></li>
            <li><a href="/posts/2013/12">2013年12月</a></li>
            <li><a href="/posts/2013/11">2013年11月</a></li>
            <li><a href="/posts/2013/10">2013年10月</a></li>
            <li><a href="/posts/2013/09">2013年09月</a></li>
            <li><a href="/posts/2013/08">2013年08月</a></li>
            <li><a href="/posts/2013/07">2013年07月</a></li>
            <li><a href="/posts/2013/01">2013年01月</a></li>
            <li><a href="/posts/2012/12">2012年12月</a></li>
          </ol>
        </div>
        <div class="sidebar-module">
          <h4>标签</h4>
          <ol class="list-unstyled">
            <li><a href="/tags/notes">notes(5)</a></li>
            <li><a href="/tags/css">css(23)</a></li>
            <li><a href="/tags/html">html(10)</a></li>
            <li><a href="/tags/JavaScript">JavaScript(106)</a></li>
            <li><a href="/tags/前端">前端(9)</a></li>
            <li><a href="/tags/jQuery">jQuery(29)</a></li>
            <li><a href="/tags/http">http(4)</a></li>
            <li><a href="/tags/node">node(3)</a></li>
            <li><a href="/tags/html5">html5(7)</a></li>
            <li><a href="/tags/Flash">Flash(30)</a></li>
          </ol>
        </div>
      </div>
    </div>
    <div class="container"></div>
    <footer class="blog-footer">
      <p>Powerby MaiZhiying</p>
    </footer>
  </body>

</html>